{{- $headers := findRE "<h[1-6].*?>(.|\n])+?</h[1-6]>" .Content -}}
{{- $has_headers := ge (len $headers) 1 -}}
{{- if $has_headers -}}
<aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details {{if (.Param "TocOpen") }} open{{ end }}>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">{{- i18n "toc" | default "Table of Contents" }}</span>
        </summary>

        <div class="inner">
            {{- $largest := 6 -}}
            {{- range $headers -}}
            {{- $headerLevel := index (findRE "[1-6]" . 1) 0 -}}
            {{- $headerLevel := len (seq $headerLevel) -}}
            {{- if lt $headerLevel $largest -}}
            {{- $largest = $headerLevel -}}
            {{- end -}}
            {{- end -}}

            {{- $firstHeaderLevel := len (seq (index (findRE "[1-6]" (index $headers 0) 1) 0)) -}}

            {{- $.Scratch.Set "bareul" slice -}}
            <ul>
                {{- range seq (sub $firstHeaderLevel $largest) -}}
                <ul>
                    {{- $.Scratch.Add "bareul" (sub (add $largest .) 1) -}}
                    {{- end -}}
                    {{- range $i, $header := $headers -}}
                    {{- $headerLevel := index (findRE "[1-6]" . 1) 0 -}}
                    {{- $headerLevel := len (seq $headerLevel) -}}

                    {{/* get id="xyz" */}}
                    {{- $id := index (findRE "(id=\"(.*?)\")" $header 9) 0 }}

                    {{- /* strip id="" to leave xyz, no way to get regex capturing groups in hugo */ -}}
                    {{- $cleanedID := replace (replace $id "id=\"" "") "\"" "" }}
                    {{- $header := replaceRE "<h[1-6].*?>((.|\n])+?)</h[1-6]>" "$1" $header -}}

                    {{- if ne $i 0 -}}
                    {{- $prevHeaderLevel := index (findRE "[1-6]" (index $headers (sub $i 1)) 1) 0 -}}
                    {{- $prevHeaderLevel := len (seq $prevHeaderLevel) -}}
                    {{- if gt $headerLevel $prevHeaderLevel -}}
                    {{- range seq $prevHeaderLevel (sub $headerLevel 1) -}}
                    <ul>
                        {{/* the first should not be recorded */}}
                        {{- if ne $prevHeaderLevel . -}}
                        {{- $.Scratch.Add "bareul" . -}}
                        {{- end -}}
                        {{- end -}}
                        {{- else -}}
                        </li>
                        {{- if lt $headerLevel $prevHeaderLevel -}}
                        {{- range seq (sub $prevHeaderLevel 1) -1 $headerLevel -}}
                        {{- if in ($.Scratch.Get "bareul") . -}}
                    </ul>
                    {{/* manually do pop item */}}
                    {{- $tmp := $.Scratch.Get "bareul" -}}
                    {{- $.Scratch.Delete "bareul" -}}
                    {{- $.Scratch.Set "bareul" slice}}
                    {{- range seq (sub (len $tmp) 1) -}}
                    {{- $.Scratch.Add "bareul" (index $tmp (sub . 1)) -}}
                    {{- end -}}
                    {{- else -}}
                </ul>
                </li>
                {{- end -}}
                {{- end -}}
                {{- end -}}
                {{- end }}
                <li>
                    <a href="#{{- $cleanedID -}}" aria-label="{{- $header | plainify -}}">{{- $header | safeHTML -}}</a>
                    {{- else }}
                <li>
                    <a href="#{{- $cleanedID -}}" aria-label="{{- $header | plainify -}}">{{- $header | safeHTML -}}</a>
                    {{- end -}}
                    {{- end -}}
                    <!-- {{- $firstHeaderLevel := len (seq (index (findRE "[1-6]" (index $headers 0) 1) 0)) -}} -->
                    {{- $firstHeaderLevel := $largest }}
                    {{- $lastHeaderLevel := len (seq (index (findRE "[1-6]" (index $headers (sub (len $headers) 1)) 1) 0)) }}
                </li>
                {{- range seq (sub $lastHeaderLevel $firstHeaderLevel) -}}
                {{- if in ($.Scratch.Get "bareul") (add . $firstHeaderLevel) }}
            </ul>
            {{- else }}
            </ul>
            </li>
            {{- end -}}
            {{- end }}
            </ul>
        </div>
        </details>
    </div>
</aside>
<script>
    // let activeElement;
    // let elements;
    // window.addEventListener('DOMContentLoaded', function (event) {
    //     checkTocPosition();

    //     elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
    //     // Make the first header active
    //     activeElement = elements[0];
    //     const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
    //     document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
    // }, false);

    // window.addEventListener('resize', function(event) {
    //     checkTocPosition();
    // }, false);

    // window.addEventListener('scroll', () => {
    //     // Check if there is an object in the top half of the screen or keep the last item active
    //     if (elements) {
    //         activeElement = Array.from(elements).find((element) => {
    //             if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
    //                 (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
    //                 return element;
    //             }
    //         }) || activeElement

    //         elements.forEach(element => {
    //             const id = encodeURI(element.getAttribute('id')).toLowerCase();
    //             if (element === activeElement){
    //                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
    //             } else {
    //                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
    //             }
    //         })
    //     }
    // }, false);
///===========================
    // const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    // const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    // const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    // function checkTocPosition() {
    //     const width = document.body.scrollWidth;
    //     if (width - main - (toc * 2) - (gap * 4) > 0) {
    //         document.getElementById("toc-container").classList.add("wide");
    //     } else {
    //         document.getElementById("toc-container").classList.remove("wide");
    //     }
    // }

    // function getOffsetTop(element) {
    //     if (!element.getClientRects().length) {
    //         return 0;
    //     }
    //     let rect = element.getBoundingClientRect();
    //     let win = element.ownerDocument.defaultView;
    //     return rect.top + win.pageYOffset;
    // }
</script>
{{- end }}



<style>
    .item-headline {
        padding-bottom: 6px;
        font-size: 1.2em
    }

     .item-headline span {
        margin-left: 6px
    }

    @media screen and (min-width:900px) {
        .sticky_layout {
            position: sticky;
            position: -webkit-sticky;
            top: 20px;
            -webkit-transition: top .3s;
            -moz-transition: top .3s;
            -o-transition: top .3s;
            -ms-transition: top .3s;
            transition: top .3s
        }
    }


    #card-toc .toc-percentage {
        float: right;
        margin-top: -9px;
        color: #a9a9a9;
        font-style: italic;
        font-size: 140%
    }

    #card-toc .toc-content {
        overflow-y: scroll;
        overflow-y: overlay;
        margin: 0 -24px;
        max-height: calc(100vh - 120px)
    }

    @media screen and (max-width:900px) {
         #card-toc .toc-content {
            max-height: calc(100vh - 140px)
        }
    }

     #card-toc .toc-content>* {
        margin: 0 20px !important
    }

     #card-toc .toc-content>*>.toc-item>.toc-child {
        margin-left: 10px;
        padding-left: 10px;
        border-left: 1px solid var(--dark-grey)
    }

    #card-toc .toc-content:not(.is-expand) .toc-child {
        display: none
    }

    @media screen and (max-width:900px) {
        #card-toc .toc-content:not(.is-expand) .toc-child {
            display: block !important
        }
    }

   #card-toc .toc-content:not(.is-expand) .toc-item.active .toc-child {
        display: block
    }

    #card-toc .toc-content li,
     #card-toc .toc-content ol {
        list-style: none
    }

     #card-toc .toc-content>ol {
        padding: 0 !important
    }

    #card-toc .toc-content ol {
        margin: 0;
        padding-left: 18px
    }

    #card-toc .toc-content .toc-link {
        display: block;
        margin: 4px 0;
        padding: 1px 6px;
        color: var(--toc-link-color);
        -webkit-transition: all .2s ease-in-out;
        -moz-transition: all .2s ease-in-out;
        -o-transition: all .2s ease-in-out;
        -ms-transition: all .2s ease-in-out;
        transition: all .2s ease-in-out
    }

     #card-toc .toc-content .toc-link:hover {
        color: #49b1f5
    }

    #card-toc .toc-content .toc-link.active {
        background: #00c4b6;
        color: #fff
    }

     .sticky_layout:only-child>:first-child {
        margin-top: 0
    }


</style>


<div class="sticky_layout">
    <div class="card-widget" id="card-toc">
        <div class="item-headline">
            <i class="fas fa-stream"></i>
            <span>目录</span>
            <span class="toc-percentage">24</span>
        </div>
        <div class="toc-content">
            <ol class="toc">
                <li class="toc-item toc-level-2">
                    <a class="toc-link" href="#%E4%B9%B0%E8%BD%A6%E7%BC%98%E7%94%B1" data-pjax-state="anchor">
                        <span class="toc-number">1.</span> 
                        <span class="toc-text">买车缘由</span>
                    </a>
                </li>
                <li class="toc-item toc-level-2 active">
                    <a class="toc-link active" href="#%E6%B1%BD%E8%BD%A6%E4%B9%8B%E5%AE%B6%E8%BF%98%E6%98%AF%E6%87%82%E8%BD%A6%E5%B8%9D%EF%BC%9F" data-pjax-state="anchor">
                        <span class="toc-number">2.</span>
                         <span class="toc-text">汽车之家还是懂车帝？</span>
                    </a>
                </li>
                    <li class="toc-item toc-level-2">
                    <a class="toc-link" href="#%E6%8A%A5%E4%BB%B7%E5%AF%B9%E6%AF%94" data-pjax-state="anchor">
                        <span class="toc-number">3.</span>
                            <span class="toc-text">报价对比</span>
                    </a>
                </li>
                <li class="toc-item toc-level-2">
                    <a class="toc-link" href="#%E4%B9%B0%E4%BA%8F%E4%BA%86%E5%90%97" data-pjax-state="anchor">
                        <span class="toc-number">4.</span>
                        <span class="toc-text">买亏了吗</span>
                    </a>
                </li>
            </ol>
        </div>
    </div>
</div>





<script>

    const btf = {
        scrollToDest: (pos, time = 500) => {
            const currentPos = window.pageYOffset
            const isNavFixed = document.getElementById('page-header').classList.contains('fixed')
            if (currentPos > pos || isNavFixed) pos = pos - 70
        
            if ('scrollBehavior' in document.documentElement.style) {
                window.scrollTo({
                top: pos,
                behavior: 'smooth'
                })
                return
            }
        
            let start = null
            pos = +pos
            window.requestAnimationFrame(function step (currentTime) {
                start = !start ? currentTime : start
                const progress = currentTime - start
                if (currentPos < pos) {
                window.scrollTo(0, ((pos - currentPos) * progress / time) + currentPos)
                } else {
                window.scrollTo(0, currentPos - ((currentPos - pos) * progress / time))
                }
                if (progress < time) {
                window.requestAnimationFrame(step)
                } else {
                window.scrollTo(0, pos)
                }
            })
        },
    
        getEleTop: ele => {
            let actualTop = ele.offsetTop
            let current = ele.offsetParent
        
            while (current !== null) {
                actualTop += current.offsetTop
                current = current.offsetParent
            }
        
            return actualTop
        },

        updateAnchor: (anchor) => {
            if (anchor !== window.location.hash) {
                if (!anchor) anchor = location.pathname
                const title = GLOBAL_CONFIG_SITE.title
                window.history.replaceState({
                url: location.href,
                title
                }, title, anchor)
            }
        },


        throttle: function (func, wait, options) {
            let timeout, context, args
            let previous = 0
            if (!options) options = {}
        
            const later = function () {
                previous = options.leading === false ? 0 : new Date().getTime()
                timeout = null
                func.apply(context, args)
                if (!timeout) context = args = null
            }
        
            const throttled = function () {
                const now = new Date().getTime()
                if (!previous && options.leading === false) previous = now
                const remaining = wait - (now - previous)
                context = this
                args = arguments
                if (remaining <= 0 || remaining > wait) {
                if (timeout) {
                    clearTimeout(timeout)
                    timeout = null
                }
                previous = now
                func.apply(context, args)
                if (!timeout) context = args = null
                } else if (!timeout && options.trailing !== false) {
                timeout = setTimeout(later, remaining)
                }
            }
        
            return throttled
        },

        getScrollPercent: (currentTop, ele) => {
            const docHeight = ele.clientHeight
            const winHeight = document.documentElement.clientHeight
            const headerHeight = ele.offsetTop
            const contentMath = (docHeight > winHeight) ? (docHeight - winHeight) : (document.documentElement.scrollHeight - winHeight)
            const scrollPercent = (currentTop - headerHeight) / (contentMath)
            const scrollPercentRounded = Math.round(scrollPercent * 100)
            const percentage = (scrollPercentRounded > 100) ? 100 : (scrollPercentRounded <= 0) ? 0 : scrollPercentRounded
            return percentage
        },




    }  



     /**
    * toc,anchor
    */
    const scrollFnToDo = function () {
      const isToc = true //GLOBAL_CONFIG_SITE.isToc
      const isAnchor = true //GLOBAL_CONFIG.isAnchor
      const $article = document.getElementById('article-container')
  
      if (!($article && (isToc || isAnchor))) return
  
      let $tocLink, $cardToc, autoScrollToc, $tocPercentage, isExpand
  
      if (isToc) {
        const $cardTocLayout = document.getElementById('card-toc')
        $cardToc = $cardTocLayout.getElementsByClassName('toc-content')[0]
        $tocLink = $cardToc.querySelectorAll('.toc-link')
        $tocPercentage = $cardTocLayout.querySelector('.toc-percentage')
        isExpand = $cardToc.classList.contains('is-expand')
  
        window.mobileToc = {
          open: () => {
            $cardTocLayout.style.cssText = 'animation: toc-open .3s; opacity: 1; right: 55px'
          },
  
          close: () => {
            $cardTocLayout.style.animation = 'toc-close .2s'
            setTimeout(() => {
              $cardTocLayout.style.cssText = "opacity:''; animation: ''; right: ''"
            }, 100)
          }
        }
  
        // toc元素點擊
        $cardToc.addEventListener('click', e => {
          e.preventDefault()
          const target = e.target.classList
          if (target.contains('toc-content')) return
          const $target = target.contains('toc-link')
            ? e.target
            : e.target.parentElement
          btf.scrollToDest(btf.getEleTop(document.getElementById(decodeURI($target.getAttribute('href')).replace('#', ''))), 300)
          if (window.innerWidth < 900) {
            window.mobileToc.close()
          }
        })
  
        autoScrollToc = item => {
          const activePosition = item.getBoundingClientRect().top
          const sidebarScrollTop = $cardToc.scrollTop
          if (activePosition > (document.documentElement.clientHeight - 100)) {
            $cardToc.scrollTop = sidebarScrollTop + 150
          }
          if (activePosition < 100) {
            $cardToc.scrollTop = sidebarScrollTop - 150
          }
        }
      }
  
      // find head position & add active class
      const list = $article.querySelectorAll('h1,h2,h3,h4,h5,h6')
      let detectItem = ''
      const findHeadPosition = function (top) {
        if (top === 0) {
          return false
        }
  
        let currentId = ''
        let currentIndex = ''
  
        list.forEach(function (ele, index) {
          if (top > btf.getEleTop(ele) - 80) {
            const id = ele.id
            currentId = id ? '#' + encodeURI(id) : ''
            currentIndex = index
          }
        })
  
        if (detectItem === currentIndex) return
  
        if (isAnchor) btf.updateAnchor(currentId)
  
        detectItem = currentIndex
  
        if (isToc) {
          $cardToc.querySelectorAll('.active').forEach(i => { i.classList.remove('active') })
  
          if (currentId === '') {
            return
          }
  
          const currentActive = $tocLink[currentIndex]
          currentActive.classList.add('active')
  
          setTimeout(() => {
            autoScrollToc(currentActive)
          }, 0)
  
          if (isExpand) return
          let parent = currentActive.parentNode
  
          for (; !parent.matches('.toc'); parent = parent.parentNode) {
            if (parent.matches('li')) parent.classList.add('active')
          }
        }
      }
  
      // main of scroll
      window.tocScrollFn = btf.throttle(() => {
        const currentTop = window.scrollY || document.documentElement.scrollTop
        // if (isToc && GLOBAL_CONFIG.percent.toc) {
         if(isToc){
          $tocPercentage.textContent = btf.getScrollPercent(currentTop, $article)
        }
        findHeadPosition(currentTop)
      }, 100)
  
      window.addEventListener('scroll', tocScrollFn)
    }
  

    scrollFnToDo()
</script>


<ol class="toc">
    <li class="toc-item toc-level-2">
        <a class="toc-link" href="#Front-matter" data-pjax-state="">
            <span class="toc-number">1.</span> 
            <span class="toc-text">Front-matter</span>
        </a>
        <ol class="toc-child">
            <li class="toc-item toc-level-3">
                <a class="toc-link active" href="#Page-Front-matter" data-pjax-state="">
                    <span class="toc-number">1.1.</span> 
                    <span class="toc-text">Page Front-matter</span>
                </a>
            </li>
            <li class="toc-item toc-level-3">
                <a class="toc-link" href="#Post-Front-matter" data-pjax-state="">
                    <span class="toc-number">1.2.</span> 
                    <span class="toc-text">Post Front-matter</span>
                </a>
            </li>
        </ol>
    </li>
    <li class="toc-item toc-level-2">
        <a class="toc-link" href="#%E6%A8%99%E7%B1%A4%E9%A0%81" data-pjax-state="">
            <span class="toc-number">2.</span> 
            <span class="toc-text">標籤頁</span>
        </a>
    </li>
    <li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E9%A1%9E%E9%A0%81" data-pjax-state=""><span
                class="toc-number">3.</span> <span class="toc-text">分類頁</span></a></li>
    <li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8B%E6%83%85%E9%8F%88%E6%8E%A5"
            data-pjax-state=""><span class="toc-number">4.</span> <span class="toc-text">友情鏈接</span></a>
        <ol class="toc-child">
            <li class="toc-item toc-level-3"><a class="toc-link"
                    href="#%E5%89%B5%E5%BB%BA%E5%8F%8B%E6%83%85%E9%8F%88%E6%8E%A5%E9%A0%81%E9%9D%A2"
                    data-pjax-state=""><span class="toc-number">4.1.</span> <span class="toc-text">創建友情鏈接頁面</span></a>
            </li>
            <li class="toc-item toc-level-3"><a class="toc-link"
                    href="#%E5%8F%8B%E6%83%85%E9%8F%88%E6%8E%A5%E6%B7%BB%E5%8A%A0" data-pjax-state=""><span
                        class="toc-number">4.2.</span> <span class="toc-text">友情鏈接添加</span></a></li>
            <li class="toc-item toc-level-3"><a class="toc-link"
                    href="#%E5%8F%8B%E6%83%85%E9%8F%88%E6%8E%A5%E9%9A%A8%E6%A9%9F%E6%8E%92%E5%BA%8F"
                    data-pjax-state=""><span class="toc-number">4.3.</span> <span class="toc-text">友情鏈接隨機排序</span></a>
            </li>
            <li class="toc-item toc-level-3"><a class="toc-link"
                    href="#%E5%8F%8B%E6%83%85%E9%8F%88%E6%8E%A5%E7%95%8C%E9%9D%A2%E8%A8%AD%E7%BD%AE"
                    data-pjax-state=""><span class="toc-number">4.4.</span> <span class="toc-text">友情鏈接界面設置</span></a>
            </li>
        </ol>
    </li>
    <li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%96%E5%BA%AB" data-pjax-state=""><span
                class="toc-number">5.</span> <span class="toc-text">圖庫</span></a>
        <ol class="toc-child">
            <li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%90%E9%A0%81%E9%9D%A2"
                    data-pjax-state=""><span class="toc-number">5.1.</span> <span class="toc-text">子頁面</span></a></li>
        </ol>
    </li>
    <li class="toc-item toc-level-2"><a class="toc-link" href="#404%E9%A0%81%E9%9D%A2" data-pjax-state=""><span
                class="toc-number">6.</span> <span class="toc-text">404頁面</span></a></li>
</ol>
