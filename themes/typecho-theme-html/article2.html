<article class="joe_detail__article animated fadeIn center-img    line-numbers ">
    <div id="post-inner">
      
        <h2 id="前言">前言</h2><h3 id="缓存和数据库一致性问题">缓存和数据库一致性问题</h3>
<p>读取缓存步骤一般没有什么问题，但是一旦涉及到数据更新，就容易出现缓存（Redis）和数据库（MySQL）间的数据一致性问题。因为写和读是并发的，没法保证顺序，就会出现缓存和数据库的数据不一致的问题。</p>
<p>无论是 <code>先删除Redis缓存，再写MySQL数据库</code>，还是 <code>先写MySQL数据库，再删除Redis缓存</code>，都有可能出现数据不一致的情况：</p>
<ul>
<li><strong>先删除Redis缓存，再写MySQL数据库</strong>：如果删除了Redis缓存，还没有来得及写MySQL数据库，另一个线程就来读取，发现缓存为空，则去数据库中读取数据写入缓存，此时缓存中的数据就是脏数据。</li>
<li><strong>先写MySQL数据库，再删除Redis缓存</strong>：如果先写了MySQL数据库，在删除Redis缓存前，写缓存的线程宕机了，没有删除掉缓存，则也会出现数据不一致情况。</li>
</ul>
<h3 id="解决方案">解决方案</h3><h4 id="方案一：采用延时双删策略">方案一：采用延时双删策略</h4>
<p>在写库前后都进行 <code>redis.del(key)</code> 操作，并且设定合理的超时时间。具体实现步骤如下：</p>
<ol>
<li>先删除缓存</li>
<li>再写数据库（在1步骤后，2步骤前，可能有 <code>读</code> 请求因缓存未命中，读到脏数据，再次将脏数据存入缓存）</li>
<li>休眠500毫秒</li>
<li>再次删除缓存（删除可能在1-2步之间被存入的脏数据）</li>
</ol>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_expander c_copy language-java line-numbers" tabindex="0"><i class="joe-font joe-icon-arrow-downb code-expander" title="折叠/展开"></i><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> data<span class="token punctuation">)</span><span class="token punctuation">{</span> 
    redis<span class="token punctuation">.</span><span class="token function">delKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    db<span class="token punctuation">.</span><span class="token function">updateData</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    redis<span class="token punctuation">.</span><span class="token function">delKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Java"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<h5 id="为什么要休眠一段时间呢？休眠多长时间合适呢？">为什么要休眠一段时间呢？休眠多长时间合适呢？</h5>
<p>至于休眠多长时间需要视自己的项目情况而定，考虑项目中读取数据的业务逻辑耗时，同时还要考虑Redis和数据库主从同步的耗时来确定自己的休眠时间。
目的：确保请求结束时，写请求可以删除读请求造成的缓存脏数据。</p>
<h5 id="缺点">缺点</h5>
<p>1、代码耦合性太高
2、白白增加接口请求耗时</p>
<h4 id="方案二：异步更新缓存(基于订阅 MySQL Binlog的同步机制)">方案二：异步更新缓存(基于订阅 MySQL Binlog的同步机制)</h4>
<p>MySQL Binlog增量订阅消费+消息队列+增量数据更新到redis</p>
<ol>
<li>读Redis：热数据基本都在Redis</li>
<li>写MySQL：增删改都是操作MySQL</li>
<li>更新Redis数据：MySQL的数据操作Binlog，然后更新到Redis</li>
</ol>
<p>那么我们如何订阅Binlog呢？如何将数据发送到消息队列呢？如何消费呢？不要慌，继续往下看，带你进入实战环节！</p>
<h2 id="实战">实战</h2>
<p>基于MySQL Binlog同步数据保障一致性的架构图大致如下：</p>
<p><span style="display: block;" data-fancybox="Joe" href="https://fastly.jsdelivr.net/gh/XuxuGood/blog-cdn@master/images/article/canal-sync-data-to-redis/Canal%E5%90%8C%E6%AD%A5%E6%95%B0%E6%8D%AE%E6%9E%B6%E6%9E%84%E5%9B%BE.png"><img src="https://fastly.jsdelivr.net/gh/XuxuGood/blog-cdn@master/images/article/canal-sync-data-to-redis/Canal%E5%90%8C%E6%AD%A5%E6%95%B0%E6%8D%AE%E6%9E%B6%E6%9E%84%E5%9B%BE.png" alt="Canal同步数据架构图"></span></p>
<h3 id="Canal是什么？">Canal是什么？</h3>
<p>我这里就不为大家再去啰嗦介绍一遍了，推荐大家阅读下Canal的简介，地址：https://github.com/alibaba/canal/wiki/%E7%AE%80%E4%BB%8B</p>
<h3 id="Canal工作原理">Canal工作原理</h3>
<ul>
<li>canal模拟mysql slave的交互协议，伪装自己为mysql slave，向mysql master发送dump协议</li>
<li>mysql master收到dump请求，开始推送binary log给slave（也就是canal）</li>
<li>canal解析binary log对象（原始为byte流）</li>
</ul>
<p>当大家仔细阅读完官方的介绍之后，对Canal也是有了一个初步的了解，接下来我们就进入实战环节。</p>
<h3 id="环境准备">环境准备</h3><h4 id="MySQL配置">MySQL配置</h4>
<p>1、对于自建 MySQL，需要先开启 Binlog 写入功能，配置 binlog-format 为 ROW 模式，my.cnf 中配置如下：</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_expander c_copy language-mysql line-numbers" tabindex="0"><i class="joe-font joe-icon-arrow-downb code-expander" title="折叠/展开"></i><code class="prism language-mysql">[mysqld]
log-bin=mysql-bin # 开启 binlog
binlog-format=ROW # 选择 ROW 模式
server_id=1 # 配置 MySQL replaction 需要定义，不要和 canal 的 slaveId 重复
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Mysql"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<p><strong>注意</strong>：针对阿里云 RDS for MySQL , 默认打开了 binlog , 并且账号默认具有 binlog dump 权限 , 不需要任何权限或者 binlog 设置,可以直接跳过这一步。</p>
<p>2、授权 Canal 链接 MySQL 账号具有作为 MySQL slave 的权限, 如果已有账户可直接 grant</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_expander c_copy language-mysql line-numbers" tabindex="0"><i class="joe-font joe-icon-arrow-downb code-expander" title="折叠/展开"></i><code class="prism language-mysql">CREATE USER canal IDENTIFIED BY 'canal';  
GRANT SELECT, REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'canal'@'%';
-- GRANT ALL PRIVILEGES ON *.* TO 'canal'@'%' ;
FLUSH PRIVILEGES;

SHOW GRANTS FOR 'canal'
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Mysql"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<h4 id="Canal的安装与配置">Canal的安装与配置</h4><h5 id="Canal Admin安装和配置">Canal Admin安装和配置</h5>
<p>canal-admin设计上是为canal提供整体配置管理、节点运维等面向运维的功能，提供相对友好的WebUI操作界面，方便更多用户快速和安全的操作。</p>
<p>1、下载 canal-admin，访问 <a href="https://github.com/alibaba/canal/releases" target="_blank" rel="noopener noreferrer nofollow">release</a> 页面，选择需要的包下载，如以 1.1.4 版本为例：</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_expander c_copy language-shell line-numbers" tabindex="0"><i class="joe-font joe-icon-arrow-downb code-expander" title="折叠/展开"></i><code class="prism language-shell"><span class="token function">wget</span> https://github.com/alibaba/canal/releases/download/canal-1.1.4/canal.admin-1.1.4.tar.gz
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Shell"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<p>2、解压缩</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_expander c_copy language-none line-numbers" tabindex="0"><i class="joe-font joe-icon-arrow-downb code-expander" title="折叠/展开"></i><code class="language-none">mkdir /canal/canal-admin
tar zxvf canal.admin-1.1.4.tar.gz  -C /canal/canal-admin
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Plain text"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<p>解压完成后，进入 /canal/canal-admin 目录，可以看到如下结构：</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_expander c_copy language-shell line-numbers" tabindex="0"><i class="joe-font joe-icon-arrow-downb code-expander" title="折叠/展开"></i><code class="prism language-shell">drwxr-xr-x   <span class="token number">7</span> xiaoxuxuy  staff   224B Mar <span class="token number">15</span> <span class="token number">16</span>:36 bin
drwxr-xr-x   <span class="token number">9</span> xiaoxuxuy  staff   288B Mar <span class="token number">13</span> <span class="token number">20</span>:27 conf
drwxr-xr-x  <span class="token number">90</span> xiaoxuxuy  staff   <span class="token number">2</span>.8K Mar <span class="token number">13</span> <span class="token number">20</span>:24 lib
drwxrwxrwx   <span class="token number">5</span> xiaoxuxuy  staff   160B Mar <span class="token number">17</span> <span class="token number">10</span>:07 logs
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Shell"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<p>3、配置修改</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_expander c_copy language-shell line-numbers" tabindex="0"><i class="joe-font joe-icon-arrow-downb code-expander" title="折叠/展开"></i><code class="prism language-shell"><span class="token function">vi</span> conf/application.yml
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Shell"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_expander c_copy language-yaml line-numbers" tabindex="0"><i class="joe-font joe-icon-arrow-downb code-expander" title="折叠/展开"></i><code class="prism language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8089</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">jackson</span><span class="token punctuation">:</span>
    <span class="token key atrule">date-format</span><span class="token punctuation">:</span> yyyy<span class="token punctuation">-</span>MM<span class="token punctuation">-</span>dd HH<span class="token punctuation">:</span>mm<span class="token punctuation">:</span>ss
    <span class="token key atrule">time-zone</span><span class="token punctuation">:</span> GMT+8

<span class="token key atrule">spring.datasource</span><span class="token punctuation">:</span>
  <span class="token key atrule">address</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">3306</span>
  <span class="token key atrule">database</span><span class="token punctuation">:</span> canal_manager
  <span class="token key atrule">username</span><span class="token punctuation">:</span> canal
  <span class="token key atrule">password</span><span class="token punctuation">:</span> canal
  <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver
  <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//$<span class="token punctuation">{</span>spring.datasource.address<span class="token punctuation">}</span>/$<span class="token punctuation">{</span>spring.datasource.database<span class="token punctuation">}</span><span class="token punctuation">?</span>useUnicode=true<span class="token important">&amp;characterEncoding=UTF-8&amp;useSSL=false</span>
  <span class="token key atrule">hikari</span><span class="token punctuation">:</span>
    <span class="token key atrule">maximum-pool-size</span><span class="token punctuation">:</span> <span class="token number">30</span>
    <span class="token key atrule">minimum-idle</span><span class="token punctuation">:</span> <span class="token number">1</span>

<span class="token key atrule">canal</span><span class="token punctuation">:</span>
  <span class="token key atrule">adminUser</span><span class="token punctuation">:</span> admin
  <span class="token key atrule">adminPasswd</span><span class="token punctuation">:</span> admin
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="YAML"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<p>4、初始化元数据库</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_expander c_copy language-mysql line-numbers" tabindex="0"><i class="joe-font joe-icon-arrow-downb code-expander" title="折叠/展开"></i><code class="prism language-mysql">mysql -h127.1 -uroot -p

# 导入初始化SQL
&gt; source conf/canal_manager.sql
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Mysql"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<ul>
<li>初始化SQL脚本里会默认创建canal_manager的数据库，建议使用root等有超级权限的账号进行初始化</li>
<li>canal_manager.sql默认会在conf目录下，也可以通过链接下载 <a href="https://raw.githubusercontent.com/alibaba/canal/master/canal-admin/canal-admin-server/src/main/resources/canal_manager.sql" target="_blank" rel="noopener noreferrer nofollow">canal_manager.sql</a></li>
</ul>
<p>5、启动</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_expander c_copy language-shell line-numbers" tabindex="0"><i class="joe-font joe-icon-arrow-downb code-expander" title="折叠/展开"></i><code class="prism language-shell"><span class="token function">sh</span> bin/startup.sh
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Shell"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<p>启动成功后，可以通过 <a href="http://127.0.0.1:8089/" target="_blank" rel="noopener noreferrer nofollow">http://127.0.0.1:8089/</a> 访问即可看到 Canal 登录页面，默认密码：admin/123456</p>
<p>6、关闭</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_expander c_copy language-none line-numbers" tabindex="0"><i class="joe-font joe-icon-arrow-downb code-expander" title="折叠/展开"></i><code class="language-none">sh bin/stop.sh
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Plain text"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<h5 id="Canal Deployer安装和配置">Canal Deployer安装和配置</h5>
<p>1、下载 canal-deployer，访问 <a href="https://github.com/alibaba/canal/releases" target="_blank" rel="noopener noreferrer nofollow">release</a> 页面，选择需要的包下载，如以 1.1.4 版本为例：</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_expander c_copy language-shell line-numbers" tabindex="0"><i class="joe-font joe-icon-arrow-downb code-expander" title="折叠/展开"></i><code class="prism language-shell"><span class="token function">wget</span> https://github.com/alibaba/canal/releases/download/canal-1.1.4/canal.deployer-1.1.4.tar.gz
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Shell"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<p>2、解压缩</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_expander c_copy language-none line-numbers" tabindex="0"><i class="joe-font joe-icon-arrow-downb code-expander" title="折叠/展开"></i><code class="language-none">mkdir /canal/canal-deployer
tar zxvf canal.deployer-1.1.4.tar.gz  -C /canal/canal-deployer
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Plain text"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<p>解压完成后，进入 /canal/canal-deployer 目录，可以看到如下结构：</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_expander c_copy language-shell line-numbers" tabindex="0"><i class="joe-font joe-icon-arrow-downb code-expander" title="折叠/展开"></i><code class="prism language-shell">drwxr-xr-x   <span class="token number">7</span> xiaoxuxuy  staff   224B Mar <span class="token number">15</span> <span class="token number">18</span>:32 bin
drwxr-xr-x  <span class="token number">11</span> xiaoxuxuy  staff   352B Mar <span class="token number">14</span> <span class="token number">17</span>:09 conf
drwxr-xr-x  <span class="token number">83</span> xiaoxuxuy  staff   <span class="token number">2</span>.6K Mar <span class="token number">13</span> <span class="token number">20</span>:27 lib
drwxrwxrwx   <span class="token number">5</span> xiaoxuxuy  staff   160B Mar <span class="token number">14</span> <span class="token number">17</span>:09 logs
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Shell"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<p>3、修改 <code>canal_local.properties</code> 文件配置来覆盖 <code>canal.properties</code> 文件</p>
<p>官方解释：目前conf下会包含canal.properties/canal_local.properties两个文件，考虑历史版本兼容性，默认配置会以canal.properties为主。</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_expander c_copy language-yaml line-numbers" tabindex="0"><i class="joe-font joe-icon-arrow-downb code-expander" title="折叠/展开"></i><code class="prism language-yaml"><span class="token comment"># register ip</span>
canal.register.ip =

<span class="token comment"># canal admin config</span>
canal.admin.manager = 127.0.0.1<span class="token punctuation">:</span><span class="token number">8089</span>
canal.admin.port = 11110
canal.admin.user = admin
canal.admin.passwd = 4ACFE3202A5FF5CF467898FC58AAB1D615029441
<span class="token comment"># admin auto register</span>
canal.admin.register.auto = true
canal.admin.register.cluster = 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="YAML"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<p>4、启动</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_expander c_copy language-shell line-numbers" tabindex="0"><i class="joe-font joe-icon-arrow-downb code-expander" title="折叠/展开"></i><code class="prism language-shell"><span class="token function">sh</span> bin/startup.sh <span class="token builtin class-name">local</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Shell"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<p>启动成功后，我们在 Canal Admin Web UI 中刷新 server 管理，可以看到 canal server 已经启动成功。</p>
<p><span style="display: block;" data-fancybox="Joe" href="https://blog-cos.xaoxu.cn/images/article/canal-sync-data-to-redis/CanalServer.png"><img src="https://blog-cos.xaoxu.cn/images/article/canal-sync-data-to-redis/CanalServer.png" alt="Canal Server"></span></p>
<p>5、修改 Canal Server 配置文件，修改消息队列相关配置</p>
<p><span style="display: block;" data-fancybox="Joe" href="https://blog-cos.xaoxu.cn/images/article/canal-sync-data-to-redis/CanalServer配置.png"><img src="https://blog-cos.xaoxu.cn/images/article/canal-sync-data-to-redis/CanalServer配置.png" alt="Canal Server配置"></span></p>
<p>我这里已 RocketMQ 为示例，RocketMQ 安装参考：<a href="https://rocketmq.apache.org/docs/quick-start/" target="_blank" rel="noopener noreferrer nofollow">RocketMQ QuickStart</a></p>
<p>启动 RocketMQ UI 管理页面，我这里用 Docker 启动了，根据自己喜欢的方式启动即可：</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_expander c_copy language-docker line-numbers" tabindex="0"><i class="joe-font joe-icon-arrow-downb code-expander" title="折叠/展开"></i><code class="prism language-docker">docker run --name rocketmq-ui -e "JAVA_OPTS=-Drocketmq.namesrv.addr=192.168.0.7:9876 -Dcom.rocketmq.sendMessageWithVIPChannel=false" -p 8082:8080 -itd styletang/rocketmq-console-ng:1.0.0
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Docker"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<p>然后我们回到 Canal Server 配置文件，我的内容如下：</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_expander c_copy language-yaml line-numbers" tabindex="0"><i class="joe-font joe-icon-arrow-downb code-expander" title="折叠/展开"></i><code class="prism language-yaml"><span class="token comment">#################################################</span>
<span class="token comment">######### 		common argument		#############</span>
<span class="token comment">#################################################</span>
<span class="token comment"># tcp bind ip</span>
canal.ip =
<span class="token comment"># register ip to zookeeper</span>
canal.register.ip =
canal.port = 11111
canal.metrics.pull.port = 11112
<span class="token comment"># canal instance user/passwd</span>
<span class="token comment"># canal.user = canal</span>
<span class="token comment"># canal.passwd = E3619321C1A937C46A0D8BD1DAC39F93B27D4458</span>

<span class="token comment"># canal admin config</span>
<span class="token comment">#canal.admin.manager = 127.0.0.1:8089</span>
canal.admin.port = 11110
canal.admin.user = admin
canal.admin.passwd = 4ACFE3202A5FF5CF467898FC58AAB1D615029441

canal.zkServers =
<span class="token comment"># flush data to zk</span>
canal.zookeeper.flush.period = 1000
canal.withoutNetty = false
<span class="token comment"># tcp, kafka, RocketMQ</span>
canal.serverMode = RocketMQ
<span class="token comment"># flush meta cursor/parse position to file</span>
canal.file.data.dir = $<span class="token punctuation">{</span>canal.conf.dir<span class="token punctuation">}</span>
canal.file.flush.period = 1000
<span class="token comment">## memory store RingBuffer size, should be Math.pow(2,n)</span>
canal.instance.memory.buffer.size = 16384
<span class="token comment">## memory store RingBuffer used memory unit size , default 1kb</span>
canal.instance.memory.buffer.memunit = 1024 
<span class="token comment">## meory store gets mode used MEMSIZE or ITEMSIZE</span>
canal.instance.memory.batch.mode = MEMSIZE
canal.instance.memory.rawEntry = true

<span class="token comment">## detecing config</span>
canal.instance.detecting.enable = false
<span class="token comment">#canal.instance.detecting.sql = insert into retl.xdual values(1,now()) on duplicate key update x=now()</span>
canal.instance.detecting.sql = select 1
canal.instance.detecting.interval.time = 3
canal.instance.detecting.retry.threshold = 3
canal.instance.detecting.heartbeatHaEnable = false

<span class="token comment"># support maximum transaction size, more than the size of the transaction will be cut into multiple transactions delivery</span>
canal.instance.transaction.size =  1024
<span class="token comment"># mysql fallback connected to new master should fallback times</span>
canal.instance.fallbackIntervalInSeconds = 60

<span class="token comment"># network config</span>
canal.instance.network.receiveBufferSize = 16384
canal.instance.network.sendBufferSize = 16384
canal.instance.network.soTimeout = 30

<span class="token comment"># binlog filter config</span>
canal.instance.filter.druid.ddl = true
canal.instance.filter.query.dcl = false
canal.instance.filter.query.dml = false
canal.instance.filter.query.ddl = false
canal.instance.filter.table.error = false
canal.instance.filter.rows = false
canal.instance.filter.transaction.entry = false

<span class="token comment"># binlog format/image check</span>
canal.instance.binlog.format = ROW<span class="token punctuation">,</span>STATEMENT<span class="token punctuation">,</span>MIXED 
canal.instance.binlog.image = FULL<span class="token punctuation">,</span>MINIMAL<span class="token punctuation">,</span>NOBLOB

<span class="token comment"># binlog ddl isolation</span>
canal.instance.get.ddl.isolation = false

<span class="token comment"># parallel parser config</span>
canal.instance.parser.parallel = true
<span class="token comment">## concurrent thread number, default 60% available processors, suggest not to exceed Runtime.getRuntime().availableProcessors()</span>
<span class="token comment">#canal.instance.parser.parallelThreadSize = 16</span>
<span class="token comment">## disruptor ringbuffer size, must be power of 2</span>
canal.instance.parser.parallelBufferSize = 256

<span class="token comment"># table meta tsdb info</span>
canal.instance.tsdb.enable = true
canal.instance.tsdb.dir = $<span class="token punctuation">{</span>canal.file.data.dir<span class="token punctuation">:</span>../conf<span class="token punctuation">}</span>/$<span class="token punctuation">{</span>canal.instance.destination<span class="token punctuation">:</span><span class="token punctuation">}</span>
canal.instance.tsdb.url = jdbc<span class="token punctuation">:</span>h2<span class="token punctuation">:</span>$<span class="token punctuation">{</span>canal.instance.tsdb.dir<span class="token punctuation">}</span>/h2;CACHE_SIZE=1000;MODE=MYSQL;
canal.instance.tsdb.dbUsername = canal
canal.instance.tsdb.dbPassword = canal
<span class="token comment"># dump snapshot interval, default 24 hour</span>
canal.instance.tsdb.snapshot.interval = 24
<span class="token comment"># purge snapshot expire , default 360 hour(15 days)</span>
canal.instance.tsdb.snapshot.expire = 360

<span class="token comment"># aliyun ak/sk , support rds/mq</span>
canal.aliyun.accessKey =
canal.aliyun.secretKey =

<span class="token comment">#################################################</span>
<span class="token comment">######### 		destinations		#############</span>
<span class="token comment">#################################################</span>
canal.destinations = cms_article<span class="token punctuation">,</span>cms_user
<span class="token comment"># conf root dir</span>
canal.conf.dir = ../conf
<span class="token comment"># auto scan instance dir add/remove and start/stop instance</span>
canal.auto.scan = true
canal.auto.scan.interval = 5

canal.instance.tsdb.spring.xml = classpath<span class="token punctuation">:</span>spring/tsdb/h2<span class="token punctuation">-</span>tsdb.xml
<span class="token comment">#canal.instance.tsdb.spring.xml = classpath:spring/tsdb/mysql-tsdb.xml</span>

canal.instance.global.mode = spring
canal.instance.global.lazy = false
canal.instance.global.manager.address = $<span class="token punctuation">{</span>canal.admin.manager<span class="token punctuation">}</span>
<span class="token comment">#canal.instance.global.spring.xml = classpath:spring/memory-instance.xml</span>
canal.instance.global.spring.xml = classpath<span class="token punctuation">:</span>spring/file<span class="token punctuation">-</span>instance.xml
<span class="token comment">#canal.instance.global.spring.xml = classpath:spring/default-instance.xml</span>

<span class="token comment">##################################################</span>
<span class="token comment">######### 		     MQ 		     #############</span>
<span class="token comment">##################################################</span>
canal.mq.servers = 192.168.0.7<span class="token punctuation">:</span><span class="token number">9876</span>
canal.mq.retries = 3
canal.mq.batchSize = 16384
canal.mq.maxRequestSize = 1048576
canal.mq.lingerMs = 100
canal.mq.bufferMemory = 33554432
canal.mq.canalBatchSize = 50
canal.mq.canalGetTimeout = 100
canal.mq.flatMessage = true
canal.mq.compressionType = none
canal.mq.acks = all
<span class="token comment">#canal.mq.properties. =</span>
canal.mq.producerGroup = cms
<span class="token comment"># Set this value to "cloud", if you want open message trace feature in aliyun.</span>
canal.mq.accessChannel = local
<span class="token comment"># aliyun mq namespace</span>
<span class="token comment">#canal.mq.namespace =</span>

<span class="token comment">##################################################</span>
<span class="token comment">#########     Kafka Kerberos Info    #############</span>
<span class="token comment">##################################################</span>
canal.mq.kafka.kerberos.enable = false
canal.mq.kafka.kerberos.krb5FilePath = "../conf/kerberos/krb5.conf"
canal.mq.kafka.kerberos.jaasFilePath = "../conf/kerberos/jaas.conf"
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="YAML"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<p>主要简单修改了以下几个位置：</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_expander c_copy language-yaml line-numbers" tabindex="0"><i class="joe-font joe-icon-arrow-downb code-expander" title="折叠/展开"></i><code class="prism language-yaml"><span class="token comment"># ...</span>
<span class="token comment"># tcp, kafka, RocketMQ</span>
canal.serverMode = RocketMQ
<span class="token comment"># ...</span>
canal.destinations = cms_article<span class="token punctuation">,</span>cms_user
<span class="token comment"># ...</span>
canal.mq.servers = 192.168.0.7<span class="token punctuation">:</span><span class="token number">9876</span>
<span class="token comment"># ...</span>
canal.mq.flatMessage = true
<span class="token comment"># ...</span>
canal.mq.producerGroup = cms
<span class="token comment"># ...</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="YAML"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<p>修改完成后，记得点击保存！保存后会自动重启。</p>
<h5 id="Canal Admin WebUI 中配置 Instance 管理">Canal Admin WebUI 中配置 Instance 管理</h5>
<p>新建 Instance -&gt; 填写 Instance 名称：cms_article -&gt; 选择所属集群/主机 -&gt; 载入模板 -&gt; 修改配置信息如下：</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_expander c_copy language-yaml line-numbers" tabindex="0"><i class="joe-font joe-icon-arrow-downb code-expander" title="折叠/展开"></i><code class="prism language-yaml"><span class="token comment">#################################################</span>
<span class="token comment">## mysql serverId , v1.0.26+ will autoGen</span>
<span class="token comment"># canal.instance.mysql.slaveId=0</span>

<span class="token comment"># enable gtid use true/false</span>
canal.instance.gtidon=false

<span class="token comment"># position info</span>
canal.instance.master.address=127.0.0.1<span class="token punctuation">:</span><span class="token number">3306</span>
canal.instance.master.journal.name=
canal.instance.master.position=
canal.instance.master.timestamp=
canal.instance.master.gtid=

<span class="token comment"># rds oss binlog</span>
canal.instance.rds.accesskey=
canal.instance.rds.secretkey=
canal.instance.rds.instanceId=

<span class="token comment"># table meta tsdb info</span>
canal.instance.tsdb.enable=true
<span class="token comment">#canal.instance.tsdb.url=jdbc:mysql://127.0.0.1:3306/canal_tsdb</span>
<span class="token comment">#canal.instance.tsdb.dbUsername=canal</span>
<span class="token comment">#canal.instance.tsdb.dbPassword=canal</span>

<span class="token comment">#canal.instance.standby.address =</span>
<span class="token comment">#canal.instance.standby.journal.name =</span>
<span class="token comment">#canal.instance.standby.position =</span>
<span class="token comment">#canal.instance.standby.timestamp =</span>
<span class="token comment">#canal.instance.standby.gtid=</span>

<span class="token comment"># username/password</span>
canal.instance.dbUsername=canal
canal.instance.dbPassword=canal
canal.instance.connectionCharset = UTF<span class="token punctuation">-</span><span class="token number">8</span>
<span class="token comment"># enable druid Decrypt database password</span>
canal.instance.enableDruid=false
<span class="token comment">#canal.instance.pwdPublicKey=MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBALK4BUxdDltRRE5/zXpVEVPUgunvscYFtEip3pmLlhrWpacX7y7GCMo2/JM6LeHmiiNdH1FWgGCpUfircSwlWKUCAwEAAQ==</span>

<span class="token comment"># table regex</span>
canal.instance.filter.regex=cms<span class="token punctuation">-</span>manage.article
<span class="token comment"># table black regex</span>
canal.instance.filter.black.regex=
<span class="token comment"># table field filter(format: schema1.tableName1:field1/field2,schema2.tableName2:field1/field2)</span>
<span class="token comment">#canal.instance.filter.field=test1.t_product:id/subject/keywords,test2.t_company:id/name/contact/ch</span>
<span class="token comment"># table field black filter(format: schema1.tableName1:field1/field2,schema2.tableName2:field1/field2)</span>
<span class="token comment">#canal.instance.filter.black.field=test1.t_product:subject/product_image,test2.t_company:id/name/contact/ch</span>

<span class="token comment"># mq config</span>
canal.mq.topic=cms_article
<span class="token comment"># dynamic topic route by schema or table regex</span>
<span class="token comment">#canal.mq.dynamicTopic=mytest1.user,mytest2\\..*,.*\\..*</span>
canal.mq.partition=0
<span class="token comment"># hash partition config</span>
<span class="token comment">#canal.mq.partitionsNum=3</span>
<span class="token comment">#canal.mq.partitionHash=test.table:id^name,.*\\..*</span>
<span class="token comment">#################################################</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="YAML"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<p>配置好之后，点击保存，此时在 Instances 管理中就可以看到新创建实例信息。</p>
<p><span style="display: block;" data-fancybox="Joe" href="https://blog-cos.xaoxu.cn/images/article/canal-sync-data-to-redis/CanalInstance.png"><img src="https://blog-cos.xaoxu.cn/images/article/canal-sync-data-to-redis/CanalInstance.png" alt="Canal Instance配置"></span></p>
<p>这里我对应着 Instance 创建了两张表进行演示。</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_expander c_copy language-mysql line-numbers" tabindex="0"><i class="joe-font joe-icon-arrow-downb code-expander" title="折叠/展开"></i><code class="prism language-mysql">DROP TABLE IF EXISTS `article`;
CREATE TABLE `article` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `content` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=12 DEFAULT CHARSET=utf8mb4;

DROP TABLE IF EXISTS `user`;
CREATE TABLE `user` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `name` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8mb4;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Mysql"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<p><span style="display: block;" data-fancybox="Joe" href="https://blog-cos.xaoxu.cn/images/article/canal-sync-data-to-redis/cms-manage.png"><img src="https://blog-cos.xaoxu.cn/images/article/canal-sync-data-to-redis/cms-manage.png" alt="cms-manage"></span></p>
<h3 id="代码实现">代码实现</h3><h4 id="引入依赖">引入依赖</h4>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_expander c_copy language-pom line-numbers" tabindex="0"><i class="joe-font joe-icon-arrow-downb code-expander" title="折叠/展开"></i><code class="prism language-pom">&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.otter&lt;/groupId&gt;
    &lt;artifactId&gt;canal.client&lt;/artifactId&gt;
    &lt;version&gt;1.1.4&lt;/version&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
    &lt;groupId&gt;org.apache.rocketmq&lt;/groupId&gt;
    &lt;artifactId&gt;rocketmq-spring-boot-starter&lt;/artifactId&gt;
    &lt;version&gt;2.0.2&lt;/version&gt;
&lt;/dependency&gt;	
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Pom"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<h4 id="添加RocketMQ配置文件，Redis自行配置">添加RocketMQ配置文件，Redis自行配置</h4>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_expander c_copy language-yaml line-numbers" tabindex="0"><i class="joe-font joe-icon-arrow-downb code-expander" title="折叠/展开"></i><code class="prism language-yaml"><span class="token comment"># 配置rocketmq</span>
<span class="token key atrule">rocketmq</span><span class="token punctuation">:</span>
  <span class="token key atrule">name-server</span><span class="token punctuation">:</span> 192.168.0.7<span class="token punctuation">:</span><span class="token number">9876</span>
  <span class="token key atrule">producer</span><span class="token punctuation">:</span>
    <span class="token key atrule">group</span><span class="token punctuation">:</span> cms <span class="token comment">#生产者</span>
  <span class="token key atrule">consumer</span><span class="token punctuation">:</span>
    <span class="token key atrule">group</span><span class="token punctuation">:</span> cms <span class="token comment">#消费者</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="YAML"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<h4 id="新增Canal监听SQL类型枚举">新增Canal监听SQL类型枚举</h4>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_expander c_copy language-java line-numbers" tabindex="0"><i class="joe-font joe-icon-arrow-downb code-expander" title="折叠/展开"></i><code class="prism language-java"><span class="token comment">/**
 * Canal监听SQL类型
 *
 * @author xiaoxuxuy
 * @date 2022/3/13 11:19 下午
 */</span>
<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"AlibabaEnumConstantsMustHaveComment"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">SqlType</span> <span class="token punctuation">{</span>

    <span class="token function">INSERT</span><span class="token punctuation">(</span><span class="token string">"INSERT"</span><span class="token punctuation">,</span> <span class="token string">"插入"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">UPDATE</span><span class="token punctuation">(</span><span class="token string">"UPDATE"</span><span class="token punctuation">,</span> <span class="token string">"更新"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">DELETE</span><span class="token punctuation">(</span><span class="token string">"DELETE"</span><span class="token punctuation">,</span> <span class="token string">"删除"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> type<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token class-name">SqlType</span><span class="token punctuation">(</span><span class="token class-name">String</span> type<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> type<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>type<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Java"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<h4 id="新增User Model对象、Article Model对象">新增User Model对象、Article Model对象</h4>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_expander c_copy language-java line-numbers" tabindex="0"><i class="joe-font joe-icon-arrow-downb code-expander" title="折叠/展开"></i><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">IdType</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">TableId</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>extension<span class="token punctuation">.</span>activerecord<span class="token punctuation">.</span></span><span class="token class-name">Model</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">ApiModel</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">ApiModelProperty</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">EqualsAndHashCode</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>experimental<span class="token punctuation">.</span></span><span class="token class-name">Accessors</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author xiaoxuxuy
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@EqualsAndHashCode</span><span class="token punctuation">(</span>callSuper <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Accessors</span><span class="token punctuation">(</span>chain <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ApiModel</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"用户Model"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"用户Model"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span><span class="token string">"主键"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@TableId</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"id"</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token class-name">IdType</span><span class="token punctuation">.</span>AUTO<span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span><span class="token string">"名字"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Java"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_expander c_copy language-java line-numbers" tabindex="0"><i class="joe-font joe-icon-arrow-downb code-expander" title="折叠/展开"></i><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">IdType</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">TableId</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>extension<span class="token punctuation">.</span>activerecord<span class="token punctuation">.</span></span><span class="token class-name">Model</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">ApiModel</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">ApiModelProperty</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">EqualsAndHashCode</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>experimental<span class="token punctuation">.</span></span><span class="token class-name">Accessors</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author xiaoxuxuy
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@EqualsAndHashCode</span><span class="token punctuation">(</span>callSuper <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Accessors</span><span class="token punctuation">(</span>chain <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ApiModel</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"文章Model"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"文章Model"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Article</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Article</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span><span class="token string">"主键"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@TableId</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"id"</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token class-name">IdType</span><span class="token punctuation">.</span>AUTO<span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span><span class="token string">"文章内容"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> content<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Java"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<h4 id="Canal同步服务">Canal同步服务</h4>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_expander c_copy language-java line-numbers" tabindex="0"><i class="joe-font joe-icon-arrow-downb code-expander" title="折叠/展开"></i><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>otter<span class="token punctuation">.</span>canal<span class="token punctuation">.</span>protocol<span class="token punctuation">.</span></span><span class="token class-name">FlatMessage</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collection</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Canal同步服务
 *
 * @author xiaoxuxuy
 * @date 2022/3/13 11:58 下午
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CanalSyncService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 处理数据
     *
     * @param flatMessage CanalMQ数据
     */</span>
    <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">FlatMessage</span> flatMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * DDL语句处理
     *
     * @param flatMessage CanalMQ数据
     */</span>
    <span class="token keyword">void</span> <span class="token function">ddl</span><span class="token punctuation">(</span><span class="token class-name">FlatMessage</span> flatMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 插入
     *
     * @param list 新增数据
     */</span>
    <span class="token keyword">void</span> <span class="token function">insert</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 更新
     *
     * @param list 更新数据
     */</span>
    <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 删除
     *
     * @param list 删除数据
     */</span>
    <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Java"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<h4 id="抽象Canal-RocketMQ通用处理服务">抽象Canal-RocketMQ通用处理服务</h4>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_expander c_copy language-java line-numbers" tabindex="0"><i class="joe-font joe-icon-arrow-downb code-expander" title="折叠/展开"></i><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span>JSON<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">TableId</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>scaffolding<span class="token punctuation">.</span>example<span class="token punctuation">.</span>canal<span class="token punctuation">.</span>enums<span class="token punctuation">.</span></span><span class="token class-name">SqlType</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>scaffolding<span class="token punctuation">.</span>example<span class="token punctuation">.</span>canal<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">CanalSyncService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>scaffolding<span class="token punctuation">.</span>example<span class="token punctuation">.</span>exception<span class="token punctuation">.</span></span><span class="token class-name">BusinessException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>scaffolding<span class="token punctuation">.</span>example<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">RedisUtils</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>otter<span class="token punctuation">.</span>canal<span class="token punctuation">.</span>protocol<span class="token punctuation">.</span></span><span class="token class-name">FlatMessage</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>collect<span class="token punctuation">.</span></span><span class="token class-name">Sets</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>connection<span class="token punctuation">.</span></span><span class="token class-name">RedisConnection</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RedisTemplate</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ReflectionUtils</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Resource</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Field</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">ParameterizedType</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 抽象Canal-RocketMQ通用处理服务
 *
 * @author xiaoxuxuy
 * @date 2022/3/13 7:07 下午
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractCanalRocketMqRedisService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">CanalSyncService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisUtils</span> redisUtils<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> classCache<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 获取Model名称
     *
     * @return Model名称
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">String</span> <span class="token function">getModelName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 处理数据
     *
     * @param flatMessage CanalMQ数据
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">FlatMessage</span> flatMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>flatMessage<span class="token punctuation">.</span><span class="token function">getIsDdl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ddl</span><span class="token punctuation">(</span>flatMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> data <span class="token operator">=</span> <span class="token function">getData</span><span class="token punctuation">(</span>flatMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">SqlType</span><span class="token punctuation">.</span>INSERT<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>flatMessage<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">insert</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">SqlType</span><span class="token punctuation">.</span>UPDATE<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>flatMessage<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">update</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">SqlType</span><span class="token punctuation">.</span>DELETE<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>flatMessage<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">delete</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * DDL语句处理
     *
     * @param flatMessage CanalMQ数据
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ddl</span><span class="token punctuation">(</span><span class="token class-name">FlatMessage</span> flatMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//TODO : DDL需要同步，删库清空，更新字段处理</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 插入
     *
     * @param list 新增数据
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insert</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">insertOrUpdate</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 更新
     *
     * @param list 更新数据
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">insertOrUpdate</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 删除
     *
     * @param list 删除数据
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> keys <span class="token operator">=</span> <span class="token class-name">Sets</span><span class="token punctuation">.</span><span class="token function">newHashSetWithExpectedSize</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">T</span> data <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            keys<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">getWrapRedisKey</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        redisUtils<span class="token punctuation">.</span><span class="token function">delAll</span><span class="token punctuation">(</span>keys<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 插入或者更新redis
     *
     * @param list 数据
     */</span>
    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">insertOrUpdate</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">executePipelined</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">RedisConnection</span> redisConnection<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">T</span> data <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token function">getWrapRedisKey</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 序列化key</span>
                <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> redisKey <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">getKeySerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 序列化value</span>
                <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> redisValue <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">getValueSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                redisConnection<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>redisValue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 封装redis的key
     *
     * @param t 原对象
     * @return key
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">getWrapRedisKey</span><span class="token punctuation">(</span><span class="token class-name">T</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">getModelName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> <span class="token function">getIdValue</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取类泛型
     *
     * @return 泛型Class
     */</span>
    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
    <span class="token keyword">protected</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getTypeArgument</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>classCache <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            classCache <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ParameterizedType</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getGenericSuperclass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getActualTypeArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> classCache<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取Object标有@TableId注解的字段值
     *
     * @param t 对象
     * @return id值
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">getIdValue</span><span class="token punctuation">(</span><span class="token class-name">T</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Field</span> fieldOfId <span class="token operator">=</span> <span class="token function">getIdField</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">makeAccessible</span><span class="token punctuation">(</span>fieldOfId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span>fieldOfId<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取Class标有@TableId注解的字段名称
     *
     * @return id字段名称
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">Field</span> <span class="token function">getIdField</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> clz <span class="token operator">=</span> <span class="token function">getTypeArgument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Field</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> clz<span class="token punctuation">.</span><span class="token function">getDeclaredFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Field</span> field <span class="token operator">:</span> fields<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">TableId</span> annotation <span class="token operator">=</span> field<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">TableId</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>annotation <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> field<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"PO类未设置@TableId注解"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BusinessException</span><span class="token punctuation">(</span><span class="token string">"PO类未设置@TableId注解"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 转换Canal的FlatMessage中data成泛型对象
     *
     * @param flatMessage Canal发送MQ信息
     * @return 泛型对象集合
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token class-name">FlatMessage</span> flatMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> sourceData <span class="token operator">=</span> flatMessage<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> targetData <span class="token operator">=</span> <span class="token class-name">Sets</span><span class="token punctuation">.</span><span class="token function">newHashSetWithExpectedSize</span><span class="token punctuation">(</span>sourceData<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">:</span> sourceData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">T</span> t <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getTypeArgument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            targetData<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> targetData<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Java"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<h4 id="Canal消息的订阅代码">Canal消息的订阅代码</h4>
<p>RocketMQ 是支持广播消费的，只需要在消费端进行配置即可，默认情况下使用的是集群消费，这就意味着如果我们配置了多个消费者实例，只会有一个实例消费消息。</p>
<p>对于更新 Redis 来说，一个实例消费消息，完成 Redis 的更新，这就够了。</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_expander c_copy language-java line-numbers" tabindex="0"><i class="joe-font joe-icon-arrow-downb code-expander" title="折叠/展开"></i><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>otter<span class="token punctuation">.</span>canal<span class="token punctuation">.</span>protocol<span class="token punctuation">.</span></span><span class="token class-name">FlatMessage</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>scaffolding<span class="token punctuation">.</span>example<span class="token punctuation">.</span>canal<span class="token punctuation">.</span></span><span class="token class-name">Model<span class="token punctuation">.</span>Article</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>scaffolding<span class="token punctuation">.</span>example<span class="token punctuation">.</span>canal<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span><span class="token class-name">AbstractCanalRocketMqRedisService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Getter</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">UtilAll</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>common<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumeFromWhere</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RocketMQMessageListener</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RocketMQListener</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RocketMQPushConsumerLifecycleListener</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author xiaoxuxuy
 * @date 2022/3/14 5:37 下午
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@RocketMQMessageListener</span><span class="token punctuation">(</span>topic <span class="token operator">=</span> <span class="token string">"cms_article"</span><span class="token punctuation">,</span> consumerGroup <span class="token operator">=</span> <span class="token string">"article"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestArticleConsumer</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractCanalRocketMqRedisService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Article</span><span class="token punctuation">&gt;</span></span>
        <span class="token keyword">implements</span> <span class="token class-name">RocketMQListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlatMessage</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">RocketMQPushConsumerLifecycleListener</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">FlatMessage</span> flatMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"consumer message {}"</span><span class="token punctuation">,</span> flatMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">process</span><span class="token punctuation">(</span>flatMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"message [%s] 消费失败"</span><span class="token punctuation">,</span> flatMessage<span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Getter</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> modelName <span class="token operator">=</span> <span class="token class-name">Article</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">prepareStart</span><span class="token punctuation">(</span><span class="token class-name">DefaultMQPushConsumer</span> consumer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// set consumer consume message from now</span>
        consumer<span class="token punctuation">.</span><span class="token function">setConsumeFromWhere</span><span class="token punctuation">(</span><span class="token class-name">ConsumeFromWhere</span><span class="token punctuation">.</span>CONSUME_FROM_LAST_OFFSET<span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">setConsumeTimestamp</span><span class="token punctuation">(</span><span class="token class-name">UtilAll</span><span class="token punctuation">.</span><span class="token function">timeMillisToHumanString3</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Java"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_expander c_copy language-java line-numbers" tabindex="0"><i class="joe-font joe-icon-arrow-downb code-expander" title="折叠/展开"></i><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>otter<span class="token punctuation">.</span>canal<span class="token punctuation">.</span>protocol<span class="token punctuation">.</span></span><span class="token class-name">FlatMessage</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>scaffolding<span class="token punctuation">.</span>example<span class="token punctuation">.</span>canal<span class="token punctuation">.</span></span><span class="token class-name">Model<span class="token punctuation">.</span>User</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>scaffolding<span class="token punctuation">.</span>example<span class="token punctuation">.</span>canal<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span><span class="token class-name">AbstractCanalRocketMqRedisService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Getter</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">UtilAll</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>common<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumeFromWhere</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RocketMQMessageListener</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RocketMQListener</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RocketMQPushConsumerLifecycleListener</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author xiaoxuxuy
 * @date 2022/3/14 5:37 下午
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@RocketMQMessageListener</span><span class="token punctuation">(</span>topic <span class="token operator">=</span> <span class="token string">"cms_user"</span><span class="token punctuation">,</span> consumerGroup <span class="token operator">=</span> <span class="token string">"user"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestUserConsumer</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractCanalRocketMqRedisService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span>
        <span class="token keyword">implements</span> <span class="token class-name">RocketMQListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlatMessage</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">RocketMQPushConsumerLifecycleListener</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">FlatMessage</span> flatMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"consumer message {}"</span><span class="token punctuation">,</span> flatMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">process</span><span class="token punctuation">(</span>flatMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"message [%s] 消费失败"</span><span class="token punctuation">,</span> flatMessage<span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Getter</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> modelName <span class="token operator">=</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">prepareStart</span><span class="token punctuation">(</span><span class="token class-name">DefaultMQPushConsumer</span> consumer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// set consumer consume message from now</span>
        consumer<span class="token punctuation">.</span><span class="token function">setConsumeFromWhere</span><span class="token punctuation">(</span><span class="token class-name">ConsumeFromWhere</span><span class="token punctuation">.</span>CONSUME_FROM_LAST_OFFSET<span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">setConsumeTimestamp</span><span class="token punctuation">(</span><span class="token class-name">UtilAll</span><span class="token punctuation">.</span><span class="token function">timeMillisToHumanString3</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Java"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<h4 id="测试">测试</h4>
<p>插入article表一条数据：</p>
<p><span style="display: block;" data-fancybox="Joe" href="https://blog-cos.xaoxu.cn/images/article/canal-sync-data-to-redis/修改article表数据.png"><img src="https://blog-cos.xaoxu.cn/images/article/canal-sync-data-to-redis/修改article表数据.png" alt="article"></span></p>
<p>观察 Redis 存储内容如下：</p>
<p><span style="display: block;" data-fancybox="Joe" href="https://blog-cos.xaoxu.cn/images/article/canal-sync-data-to-redis/Redis.png"><img src="https://blog-cos.xaoxu.cn/images/article/canal-sync-data-to-redis/Redis.png" alt="Redis"></span></p>
<p>看到 RocketMQ 数据成功消费存储到 Redis 中。</p>
<p>Enjoy life ！！！🤩🤩🤩</p>

      
      
    </div>
    
  </article>